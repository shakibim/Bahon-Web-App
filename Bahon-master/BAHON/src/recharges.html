<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bahon - Recharge List</title>
  
  <!-- Firebase SDK - Add type="module" to use ES Modules -->
  <script type="module">
    // Firebase config (replace with your own values)
    const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
  measurementId: "YOUR_MEASUREMENT_ID"
};

    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  
    // Show loading dialog
    function showLoading() {
      const loadingDialog = document.getElementById("loadingDialog");
      if (loadingDialog) {
        loadingDialog.style.display = "block";
      }
    }
  
    // Hide loading dialog
    function hideLoading() {
      const loadingDialog = document.getElementById("loadingDialog");
      if (loadingDialog) {
        loadingDialog.style.display = "none";
      }
    }
  
    // Function to load recharge data
    let isLoading = false; // Flag to prevent double loading
let currentData = []; // Array to hold the current data in the list

function loadRecharges() {
  const tableBody = document.getElementById("tableBody");
  const usersRef = collection(db, "users");

  // Early exit if already loading
  if (isLoading) return;

  isLoading = true;  // Set loading state to true

  showLoading();  // Show loading indicator

  // Reset the data array on initial load to avoid duplicate entries
  currentData = [];

  const unsubscribeUsers = onSnapshot(usersRef, (usersQuerySnapshot) => {
    usersQuerySnapshot.forEach((userDoc) => {
      const rechargeRef = collection(userDoc.ref, "recharge_history");
      const rechargeQuery = query(rechargeRef, orderBy("timestamp", "desc"));

      const unsubscribeRecharges = onSnapshot(rechargeQuery, (rechargeQuerySnapshot) => {
        rechargeQuerySnapshot.forEach((doc) => {
          const data = doc.data();
          const timestamp = data.timestamp;
          const amount = data.amount;
          const userName = userDoc.data().name || "Unknown";
          const cardNo = userDoc.data().card_no;
          const formattedDate = new Date(timestamp).toLocaleString("en-GB", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: true,
          });

          // Create a unique identifier for each entry (e.g., using timestamp)
          const entry = {
            userName,
            cardNo,
            formattedDate,
            amount,
            timestamp,
          };

          // Check if the entry is already in the currentData array
          if (!currentData.some(existingEntry => existingEntry.timestamp === timestamp)) {
            currentData.push(entry);  // Add the new entry if not already present
          }
        });

        // Sort the recharges array by timestamp (descending order)
        currentData.sort((a, b) => b.timestamp - a.timestamp);

        let index = 1;

        // Clear the existing table rows
        tableBody.innerHTML = "";

        // Render the sorted recharges
        currentData.forEach((recharge) => {
          const row = document.createElement("div");
          row.className = "grid grid-cols-3 sm:grid-cols-5 gap-2 items-center border-b border-stroke dark:border-strokedark";
          row.innerHTML = `
            <div class="p-2 text-center w-1/10">
              <p class="text-[15px] font-medium text-black dark:text-white">${index++}</p>
            </div>
            <div class="p-2 text-center w-1/10">
              <p class="text-[15px] font-medium text-black dark:text-white">${recharge.userName}</p>
            </div>
            <div class="p-2 text-center w-1/10">
              <p class="text-[15px] font-medium text-black dark:text-white">${recharge.cardNo}</p>
            </div>
            <div class="p-2 text-center hidden sm:block w-6/10">
              <p class="text-[15px] font-medium text-black dark:text-white">${recharge.formattedDate}</p>
            </div>
            <div class="p-2 text-center hidden sm:block w-1/10">
              <p class="text-[15px] font-bold text-[#3CB043] dark:text-white">${recharge.amount} BDT</p>
            </div>
          `;
          tableBody.appendChild(row);
        });

        // Hide the loading spinner after the data has been loaded
        hideLoading();

        // Reset loading flag after data is loaded
        isLoading = false;
      });
    });
  });
}

  
    // Load the recharges when the page loads
    window.onload = loadRecharges;
  </script>
  
</head>

<body x-data="{ page: 'tables', 'loaded': true, 'darkMode': true, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }" x-init="darkMode = JSON.parse(localStorage.getItem('darkMode')); $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))" :class="{'dark text-bodydark bg-[#DCE8FE]': darkMode === true}">
  <!-- ===== Preloader Start ===== -->
  <include src="./partials/preloader.html"></include>
  <!-- ===== Preloader End ===== -->

  <!-- ===== Page Wrapper Start ===== -->
  <div class="flex h-screen overflow-hidden">
    <!-- ===== Sidebar Start ===== -->
    <include src="./partials/sidebar.html"></include>
    <!-- ===== Sidebar End ===== -->

    <!-- ===== Content Area Start ===== -->
    <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
      <!-- ===== Header Start ===== -->
      <include src="./partials/header.html" />
      <!-- ===== Header End ===== -->

      <!-- ===== Main Content Start ===== -->
      <main>
        <div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
          <!-- Breadcrumb Start -->
          <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <h2 class="text-title-md2 font-bold text-black dark:text-white">
              All Recharges
            </h2>
          </div>
          <!-- Breadcrumb End -->

          <!-- ====== Table Section Start -->
          <div class="flex flex-col gap-10">
            <!-- ====== Table One Start -->
            <div class="rounded-[20px] border border-stroke bg-white px-5 pb-2.5 pt-6 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 xl:pb-1">
              <h4 class="mb-6 text-xl font-bold text-black dark:text-white">Recharge List</h4>
              <div class="flex flex-col">
                <!-- Table Header -->
                <div class="overflow-x-auto">
                  <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 items-center rounded-[5px] bg-gray text-black dark:bg-meta-4">
                    <div class="p-2 text-center">
                      <h5 class="text-xs font-bold text-[#015FC9] sm:text-sm">Serial</h5>
                    </div>
                    <div class="p-2 text-center">
                      <h5 class="text-xs font-bold text-[#015FC9] sm:text-sm">Passenger Name</h5>
                    </div>
                    <div class="p-2 text-center">
                      <h5 class="text-xs font-bold text-[#015FC9] sm:text-sm">Card Number</h5>
                    </div>
                    <div class="p-2 text-center hidden sm:block">
                      <h5 class="text-xs font-bold text-[#015FC9] sm:text-sm">Date & Time</h5>
                    </div>
                    <div class="p-2 text-center hidden sm:block">
                      <h5 class="text-xs font-bold text-[#015FC9] sm:text-sm">Recharge Amount</h5>
                    </div>
                  </div>
                </div>

                <!-- Table Body -->
                <div id="tableBody"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
</body>

</html>
