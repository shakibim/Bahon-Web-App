<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bahon - Admin List</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.1/dist/cdn.min.js" defer></script>
  <style>
    /* Apply a blue shade to even rows */
    .table-container tr:nth-child(even) {
      background-color: #f8f8f8f7;
      /* Light blue color */
    }

    /* General styling for popup overlay */
    .popup-overlay {
      position: fixed;
      /* Fix the overlay to the screen */
      top: 0;
      /* Position at the top of the viewport */
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      /* Semi-transparent background */
      display: flex;
      /* Flexbox for centering content */
      justify-content: center;
      /* Horizontally center the content */
      align-items: flex-start;
      /* Align the content to the top of the screen */
      z-index: 9999;
      /* Ensure it's above other elements */
      padding-top: 50px;
      /* Add space from the top of the screen (adjust as needed) */
      box-sizing: border-box;
      /* Include padding in the height and width */
    }

    /* Style for popup content */
    .popup-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10000;
      /* Ensure the content appears on top of the overlay */
    }


    /* Style for close button */
    #popup-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      color: #333;
      cursor: pointer;
    }

    #popup-close:hover {
      color: red;
    }

    /* Ensure input fields in the form are styled properly */
    #edit-form input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #edit-form button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }

    /* Style for cancel button */
    #cancel-button {
      background-color: #f44336;
      /* Red background for cancel */
      margin-top: 10px;
    }

    #popup-close:hover {
      color: red;
    }

    /* Ensure input fields in the form are styled properly */
    #edit-form input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #edit-form button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }

    #popup-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      color: #333;
      cursor: pointer;
    }

    #popup-close:hover {
      color: red;
    }

    /* Ensure the form input fields and buttons inside the popup look consistent */
    #edit-form label {
      display: block;
      margin-bottom: 5px;
    }

    #edit-form input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #edit-form button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      background-color: #015FC9;
      color: white;
      cursor: pointer;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js"></script>
</head>

<body
  x-data="{ page: 'tables', loaded: true, darkMode: true, stickyMenu: false, sidebarToggle: false, scrollTop: false }"
  x-init="darkMode = JSON.parse(localStorage.getItem('darkMode')); $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
  :class="{'dark text-bodydark bg-[#DCE8FE]': darkMode === true}">

  <!-- ===== Preloader Start ===== -->
  <include src="./partials/preloader.html"></include>
  <!-- ===== Preloader End ===== -->

  <!-- ===== Page Wrapper Start ===== -->
  <div class="flex h-screen overflow-hidden">
    <!-- ===== Sidebar Start ===== -->
    <include src="./partials/sidebar.html"></include>
    <!-- ===== Sidebar End ===== -->

    <!-- ===== Content Area Start ===== -->
    <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
      <!-- ===== Header Start ===== -->
      <include src="./partials/header.html" />
      <!-- ===== Header End ===== -->

      <!-- ===== Main Content Start ===== -->
      <main>
        <div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
          <!-- Breadcrumb Start -->
          <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <h2 class="text-title-lg font-bold text-black dark:text-white">
              All Admins
            </h2>
            <button class="rounded bg-blue-500 px-3 py-1 text-sm font-semibold text-white hover:bg-green-600">
              Add a New Admin
            </button>
          </div>
          <!-- Breadcrumb End -->

          <!-- ====== Table Section Start ===== -->
          <div
            class="rounded-[20px] border border-stroke bg-white px-5 pb-2.5 pt-6 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 xl:pb-1">
            <h4 class="mb-6 text-xl font-bold text-black dark:text-white">
              Admin List
            </h4>

            <div class="table-container">
              <!-- Table Start -->
              <table class="min-w-full">
                <thead>
                  <tr class="grid grid-cols-3 bg-gray text-black dark:bg-meta-4 sm:grid-cols-9">
                    <th class="text-[13px] text-center xl:p-5">
                      <h5 class="text-sm font-bold text-[#015FC9] xsm:text-base">Serial</h5>
                    </th>
                    <th class="text-[13px] text-center xl:p-5">
                      <h5 class="text-sm font-bold text-[#015FC9] xsm:text-base">Name</h5>
                    </th>
                    <th class="text-[13px] text-center xl:p-5">
                      <h5 class="text-sm font-bold text-[#015FC9] xsm:text-base">E-mail</h5>
                    </th>
                    <th class="hidden text-[13px] text-center sm:block xl:p-5">
                      <h5 class="text-sm font-bold text-[#015FC9] xsm:text-base">Phone</h5>
                    </th>
                    <th class="hidden text-[13px] text-center sm:block xl:p-5">
                      <h5 class="text-sm font-bold text-[#015FC9] xsm:text-base">Address</h5>
                    </th>
                    <th class="hidden text-[13px] text-center sm:block xl:p-5">
                      <h5 class="text-sm font-bold text-[#015FC9] xsm:text-base">Card No</h5>
                    </th>
                    <th class="hidden text-[13px] text-center sm:block xl:p-5">
                      <h5 class="text-sm font-bold text-[#015FC9] xsm:text-base">Balance</h5>
                    </th>
                    <th class="hidden text-[13px] text-center sm:block xl:p-5">
                      <h5 class="text-sm font-bold text-[#015FC9] xsm:text-base">Bonus</h5>
                    </th>
                    <th class="hidden text-[13px] text-center sm:block xl:p-5">
                      <!-- Empty header for action buttons -->
                    </th>
                  </tr>
                </thead>
                <tbody id="user-list">
                  <!-- Dynamically populated rows will go here -->
                </tbody>
              </table>
              <!-- Table End -->
            </div>
            <!-- ====== Table Section End ===== -->
          </div>
        </div>
      </main>
    </div>
  </div>


  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    // Firebase configuration
   const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
  measurementId: "YOUR_MEASUREMENT_ID"
};


    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Load user data from Firestore
    const loadUserData = async () => {
      const userList = document.getElementById("user-list");
      let serial = 1; // Counter for serial numbers

      try {
        const querySnapshot = await getDocs(collection(db, "users"));
        querySnapshot.forEach((doc) => {
          const user = doc.data();
          if (user.userType === "admin"){
          const row = `
             <tr class="grid grid-cols-3 border-b border-stroke dark:border-strokedark sm:grid-cols-9">
              <td class="text-[#015FC9] text-center xl:p-5">
                <p class="font-bold text-[#015FC9] dark:text-white">${serial++}</p>
              </td>
              <td class="text-[14px] text-center xl:p-5">
                <p class="font-bold text-[#015FC9] dark:text-white">${user.name}</p>
              </td>
              <td class="text-[14px] text-center xl:p-4">
                <p class="font-medium text-black break-words">${user.email}</p>
              </td>
              <td class="text-[14px] text-center sm:block xl:p-5">
                <p class="font-medium text-black dark:text-white break-words">${user.phone}</p>
              </td>
              <td class="text-[14px] text-center sm:block xl:p-5">
                <p class="font-medium text-black dark:text-white">${user.address}</p>
              </td>
              <td class="text-[14px] text-center sm:block xl:p-5">
                <p class="font-medium text-black dark:text-white">${user.card_no}</p>
              </td>
              <td class="text-[14px] text-center sm:block xl:p-5">
                <p class="font-bold text-[#3CB043] dark:text-white">  ${user.balance != null ? parseFloat(user.balance).toFixed(2) + " BDT" : "N/A"}</p>
              </td>
              <td class="text-[14px] text-center sm:block xl:p-5">
                <p class="font-bold text-[#3CB043] dark:text-white"> ${user.bonus != null ? parseFloat(user.bonus).toFixed(2) + " BDT" : "N/A"}</p>
              </td>
              <td class="hidden flex items-center justify-center gap-2 p-2.5 sm:flex xl:p-5">
                <button onclick="openEditPopup('${doc.id}', this)" class="rounded bg-blue-500 px-3 py-1 text-[15px] font-semibold text-white hover:bg-blue-600">
                  Edit
                </button>
                <button onclick="deleteUser('${doc.id}')" class="rounded bg-red-500 px-3 py-1 text-[15px] font-semibold text-white hover:bg-red-600">
                  Delete
                </button>
              </td>
            </tr>
          `;
          userList.insertAdjacentHTML("beforeend", row);
        }});
      } catch (error) {
        console.error("Error fetching user data: ", error);
      }
    };

    window.closePopup = function (event) {
      event.stopPropagation();  // Prevent event propagation
      const popup = document.getElementById("popup-overlay");
      count=0;
      // Check if the popup element exists before trying to hide it
      if (popup) {
        popup.style.display = "none";  // Hide the popup
      } else {
        console.warn("Popup element not found!");
      }
    };


    let count = 0;
    // Edit Popup
    window.openEditPopup = function (userId, buttonElement) {

      if (count == 0) {
        
      count++;
      const popup = document.getElementById("popup-overlay");


      const form = document.getElementById("edit-form");
      const row = buttonElement.closest('tr');
      const formRow = document.createElement("tr");
      formRow.innerHTML = `
    <td colspan="9">
      <div id="popup-overlay" class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark">
        <div class="border-b border-stroke px-7 py-4 dark:border-strokedark">
          <h3 class="font-medium text-[#015FC9] dark:text-white">Edit Admin</h3>
        </div>
        <div class="p-7">
          <form id="edit-form">
            <!-- Input Row 1 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Name -->
              <div>
                <label class="mb-3 block text-sm font-medium text-black dark:text-white" for="name">Name</label>
                <input
                  class="w-full h-[42px] rounded border border-stroke bg-gray px-4 font-medium text-black focus:border-primary focus-visible:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white dark:focus:border-primary"
                  type="text"
                  id="name"
                  name="name"
                  placeholder="Enter name"
                  required
                />
              </div>
              <!-- Email -->
              <div>
                <label class="mb-3 block text-sm font-medium text-black dark:text-white" for="email">Email</label>
                <input
                  class="w-full h-[42px] rounded border border-stroke bg-gray px-4 font-medium text-black focus:border-primary focus-visible:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white dark:focus:border-primary"
                  type="email"
                  id="email"
                  name="email"
                  placeholder="Enter email"
                  required
                />
              </div>
              <!-- Phone -->
              <div>
                <label class="mb-3 block text-sm font-medium text-black dark:text-white" for="phone">Phone</label>
                <input
                  class="w-full h-[42px] rounded border border-stroke bg-gray px-4 font-medium text-black focus:border-primary focus-visible:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white dark:focus:border-primary"
                  type="text"
                  id="phone"
                  name="phone"
                  placeholder="Enter phone"
                  required
                />
              </div>
            </div>
            <!-- Input Row 2 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
              <!-- Address -->
              <div>
                <label class="mb-3 block text-sm font-medium text-black dark:text-white" for="address">Address</label>
                <input
                  class="w-full h-[42px] rounded border border-stroke bg-gray px-4 font-medium text-black focus:border-primary focus-visible:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white dark:focus:border-primary"
                  type="text"
                  id="address"
                  name="address"
                  placeholder="Enter address"
                  required
                />
              </div>
              <!-- Card No -->
              <div>
                <label class="mb-3 block text-sm font-medium text-black dark:text-white" for="card_no">Card No</label>
                <input
                  class="w-full h-[42px] rounded border border-stroke bg-gray px-4 font-medium text-black focus:border-primary focus-visible:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white dark:focus:border-primary"
                  type="text"
                  id="card_no"
                  name="card_no"
                  placeholder="Enter card number"
                  required
                />
              </div>
              <!-- Balance -->
              <div>
                <label class="mb-3 block text-sm font-medium text-black dark:text-white" for="balance">Balance</label>
                <input
                  class="w-full h-[42px] rounded border border-stroke bg-gray px-4 font-medium text-black focus:border-primary focus-visible:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white dark:focus:border-primary"
                  type="number"
                  id="balance"
                  name="balance"
                  placeholder="Enter balance"
                  required
                />
              </div>
            </div>
            <!-- Input Row 3 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
              <!-- Bonus -->
              <div>
                <label class="mb-3 block text-sm font-medium text-black dark:text-white" for="bonus">Bonus</label>
                <input
                  class="w-full h-[42px] rounded border border-stroke bg-gray px-4 font-medium text-black focus:border-primary focus-visible:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white dark:focus:border-primary"
                  type="number"
                  id="bonus"
                  name="bonus"
                  placeholder="Enter bonus"
                  required
                />
              </div>
            </div>
            <!-- Buttons -->
            <div class="flex justify-start gap-2 mt-6">
             <button
  class="h-[42px] w-[180px] rounded-[5px] border border-stroke px-3 text-sm font-medium text-black hover:bg-opacity-90 dark:border-strokedark dark:text-white"
  type="button"
  id="cancel-button"
  onclick="closePopup(event)"
  style="width: auto; min-width: 120px;"
>
  Cancel
</button>
              <button
                class="h-[42px] w-[180px] rounded-[5px] bg-[#015FC9] px-3 text-sm font-medium text-white hover:bg-opacity-90"
                type="submit"
                style="width: auto; min-width: 120px;"
              >
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </td>
  `;

      row.insertAdjacentElement('afterend', formRow);

      // Fetch user data to pre-fill the form
      const userRef = doc(db, "users", userId);
      getDoc(userRef).then(docSnap => {
        const user = docSnap.data();

        document.getElementById("name").value = user.name;
        document.getElementById("email").value = user.email;
        document.getElementById("phone").value = user.phone;
        document.getElementById("address").value = user.address;
        document.getElementById("card_no").value = user.card_no;
        document.getElementById("balance").value = user.balance;
        document.getElementById("bonus").value = user.bonus;

        popup.style.display = "flex";  // Make the popup visible
      });

      // Handle form submission for editing
      form.onsubmit = async (e) => {
        e.preventDefault();
        const userRef = doc(db, "users", userId);

        await updateDoc(userRef, {
          name: form.name.value,
          email: form.email.value,
          phone: form.phone.value,
          address: form.address.value,
          card_no: form.card_no.value,
          balance: parseFloat(form.balance.value),
          bonus: parseFloat(form.bonus.value)
        });

        alert("User updated successfully!");
        location.reload();  // Reload to reflect changes
      };

      const cancelButton = document.getElementById("cancel-button");
      cancelButton.addEventListener('click', closePopup);
    }};


    // Load user data on page load
    loadUserData();
  </script>
</body>

</html>