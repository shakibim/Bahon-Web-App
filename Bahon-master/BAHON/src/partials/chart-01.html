<div class="col-span-12 rounded-[20px] border border-stroke bg-white px-5 pb-5 pt-7.5 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 xl:col-span-8">
  <div class="flex flex-wrap items-start justify-between gap-3 sm:flex-nowrap">
    <div class="flex w-full flex-wrap gap-3 sm:gap-5">
      <div class="flex min-w-47.5">
        <span class="mr-2 mt-1 flex h-4 w-full max-w-4 items-center justify-center rounded-full border border-[#015FC9]">
          <span class="block h-2.5 w-full max-w-2.5 rounded-full bg-[#015FC9]"></span>
        </span>
        <div class="w-full">
          <p class="font-semibold text-[#015FC9]">Total Revenue</p>
          <p class="text-sm font-medium">01.11.2024 - 28.02.2025</p>
        </div>
      </div>
      <div class="flex min-w-47.5">
        <span class="mr-2 mt-1 flex h-4 w-full max-w-4 items-center justify-center rounded-full border border-[#B91C1C]">
          <span class="block h-2.5 w-full max-w-2.5 rounded-full bg-[#B91C1C]"></span>
        </span>
        <div class="w-full">
          <p class="font-semibold text-[#B91C1C]">Total Journey</p>
          <p class="text-sm font-medium">01.11.2024 - 28.02.2025</p>
        </div>
      </div>
    </div>
    <div class="flex w-full max-w-45 justify-end">
      <div class="inline-flex items-center rounded-md bg-whiter p-1.5 dark:bg-meta-4">
        <button class="rounded bg-white px-3 py-1 text-xs font-medium text-black shadow-card hover:bg-white hover:shadow-card dark:bg-boxdark dark:text-white dark:hover:bg-boxdark">
          Day
        </button>
        <button class="rounded px-3 py-1 text-xs font-medium text-black hover:bg-white hover:shadow-card dark:text-white dark:hover:bg-boxdark">
          Week
        </button>
        <button class="rounded px-3 py-1 text-xs font-medium text-black hover:bg-white hover:shadow-card dark:text-white dark:hover:bg-boxdark">
          Month
        </button>
      </div>
    </div>
  </div>
  <div>
    <div id="chartOne" class="-ml-5"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js"></script>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<!-- Your Custom JavaScript to fetch Firebase data and render the chart -->
<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBWqzzJEYOzrVMaEMf6HFs29zC8-LdPmSI",
    authDomain: "bahon-71454.firebaseapp.com",
    databaseURL: "https://bahon-71454-default-rtdb.firebaseio.com",
    projectId: "bahon-71454",
    storageBucket: "bahon-71454.firebasestorage.app",
    messagingSenderId: "137251206557",
    appId: "1:137251206557:web:745f028dc37165f5636b74",
    measurementId: "G-4R1DT12J1G"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore(app);

  // Fetch data from Firestore
  const fetchJourneyData = () => {
    const journeysData = {};

    // Query all users' journeys
    const queryRef = db.collection('users').orderBy('journeys.exit_time');

    queryRef.onSnapshot((snapshot) => {
      if (snapshot.empty) {
        console.log('No data available!');
        return;
      }

      snapshot.forEach((doc) => {
        const userJourneys = doc.data().journeys;

        userJourneys.forEach((journey) => {
          const exitDate = journey.exit_time.toDate(); // Convert Firebase Timestamp to Date
          const day = `${exitDate.getDate()}-${exitDate.getMonth() + 1}-${exitDate.getFullYear()}`;
          const fare = journey.fare;

          if (!journeysData[day]) {
            journeysData[day] = { journeys: 0, fare: 0 };
          }
          journeysData[day].journeys += 1;
          journeysData[day].fare += fare;
        });
      });

      console.log('Journeys Data:', journeysData); // Log the data fetched from Firebase
      updateChart(journeysData);
    }, (error) => {
      console.error('Error fetching data: ', error);
    });
  };

  // Update Chart with Fetched Data
  const updateChart = (journeysData) => {
    const dates = Object.keys(journeysData);
    const totalJourneys = dates.map(date => journeysData[date].journeys);
    const totalFare = dates.map(date => journeysData[date].fare);

    const chartOneOptions = {
      series: [
        {
          name: "Total Journeys",
          data: totalJourneys,
        },
        {
          name: "Total Fare",
          data: totalFare,
        },
      ],
      legend: {
        show: true,
        position: "top",
        horizontalAlign: "left",
      },
      colors: ["#B91C1C", "#015FC9"],
      chart: {
        fontFamily: "Satoshi, sans-serif",
        height: 335,
        type: "area",
        dropShadow: {
          enabled: true,
          color: "#623CEA14",
          top: 10,
          blur: 4,
          left: 0,
          opacity: 0.0,
        },
        toolbar: {
          show: false,
        },
      },
      fill: {
        type: "solid",
        opacity: [0.1, 0.05],
      },
      responsive: [
        {
          breakpoint: 1024,
          options: {
            chart: {
              height: 300,
            },
          },
        },
        {
          breakpoint: 1366,
          options: {
            chart: {
              height: 350,
            },
          },
        },
      ],
      stroke: {
        width: [2, 2],
        curve: "straight",
      },
      markers: {
        size: 0,
      },
      labels: {
        show: false,
        position: "top",
      },
      grid: {
        xaxis: {
          lines: {
            show: true,
          },
        },
        yaxis: {
          lines: {
            show: true,
          },
        },
      },
      dataLabels: {
        enabled: false,
      },
      markers: {
        size: 4,
        colors: "#fff",
        strokeColors: ["#B91C1C", "#015FC9"],
        strokeWidth: 4,
        strokeOpacity: 0.9,
        strokeDashArray: 0,
        fillOpacity: 0,
        discrete: [],
        hover: {
          size: undefined,
          sizeOffset: 5,
        },
      },
      xaxis: {
        type: "category",
        categories: dates, // Use the fetched dates as categories
        axisBorder: {
          show: false,
        },
        axisTicks: {
          show: false,
        },
      },
      yaxis: {
        title: {
          style: {
            fontSize: "0px",
          },
        },
        min: 0,
      },
    };

    // Render chart with updated data
    const chartSelector = document.querySelectorAll("#chartOne");

    if (chartSelector.length) {
      const chartOne = new ApexCharts(
        document.querySelector("#chartOne"),
        chartOneOptions
      );
      chartOne.render();
    } else {
      console.error('Chart container not found!');
    }
  };

  // Initialize Data Fetching
  fetchJourneyData();
</script>
